package com.codereview.aicodereviewer.service;

import com.codereview.aicodereviewer.model.CodeIssue;
import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.*;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;

import java.util.ArrayList;
import java.util.List;

/**
 * Service to analyze code using the trained ML model (83.93% accuracy!)
 * Integrates with FastAPI vulnerability detection service
 */
@Service
@Slf4j
public class VulnerabilityDetectionService {

    @Value("${ml.model.api.url:http://localhost:8000}")
    private String mlApiUrl;

    private final RestTemplate restTemplate = new RestTemplate();

    /**
     * Analyze Java code for security vulnerabilities using trained ML model
     *
     * @param code     Java source code to analyze
     * @param fileName Name of the file
     * @return List of detected issues (empty if safe or service unavailable)
     */
    public List<CodeIssue> analyzeCode(String code, String fileName) {
        List<CodeIssue> issues = new ArrayList<>();

        try {
            log.info("ML Model analyzing: {}", fileName);

            // Check if service is available
            if (!isAvailable()) {
                log.warn("ML model service not available, skipping ML analysis");
                return issues;
            }

            // Build request
            MLAnalysisRequest request = new MLAnalysisRequest(code, fileName);

            // Call FastAPI
            String url = mlApiUrl + "/analyze";
            HttpHeaders headers = new HttpHeaders();
            headers.setContentType(MediaType.APPLICATION_JSON);
            HttpEntity<MLAnalysisRequest> entity = new HttpEntity<>(request, headers);

            ResponseEntity<MLAnalysisResponse> response = restTemplate.exchange(
                    url,
                    HttpMethod.POST,
                    entity,
                    MLAnalysisResponse.class
            );

            if (response.getBody() != null) {
                MLAnalysisResponse result = response.getBody();

                log.info("ML Result: {} (confidence: {}%)",
                        result.getPrediction(),
                        String.format("%.1f", result.getConfidence() * 100));

                // Only flag if vulnerable
                if (result.isVulnerable()) {
                    CodeIssue issue = CodeIssue.builder()
                            .fileName(fileName)
                            .lineNumber(1) // File-level detection
                            .severity("error")
                            .issueType("ml_security_vulnerability")
                            .description(buildMLDescription(result))
                            .suggestion(buildMLSuggestion())
                            .build();

                    issues.add(issue);
                    log.info("ML Model flagged {} as vulnerable", fileName);
                } else if (result.isVulnerable()) {
                    log.info("ML flagged as vulnerable but confidence too low ({:.1f}%), skipping",
                            result.getConfidence() * 100);
                } else {
                    log.info("ML Model: {} appears safe", fileName);
                }
            }

        } catch (Exception e) {
            log.error("Error calling ML model API: {}", e.getMessage());
            // Don't break the review if ML model fails - degrade gracefully
        }

        return issues;
    }

    /**
     * Build detailed description for ML detection
     */
    private String buildMLDescription(MLAnalysisResponse result) {
        return String.format(
                "**ML-Detected Security Vulnerability**\n\n" +
                        "**Model:** GraphCodeBERT (Trained, 83.93%% test accuracy)\n" +
                        "**Prediction:** %s\n" +
                        "**Confidence:** %.1f%%\n\n" +
                        "The machine learning model has identified potential security issues in this code. " +
                        "While the model is highly accurate, please review the detailed analysis below for confirmation.",
                result.getPrediction(),
                result.getConfidence() * 100
        );
    }

    /**
     * Build suggestion text
     */
    private String buildMLSuggestion() {
        return "**Common Vulnerabilities to Check:**\n" +
                "- SQL Injection (string concatenation in queries)\n" +
                "- Cross-Site Scripting (XSS) (unescaped user input)\n" +
                "- Path Traversal (unsanitized file paths)\n" +
                "- Command Injection (external command execution)\n" +
                "- Insecure Deserialization\n" +
                "- XXE (XML External Entity)\n\n" +
                "**Recommendation:** Review the Gemini AI analysis below for specific details.";
    }

    /**
     * Check if ML model API is available
     */
    public boolean isAvailable() {
        try {
            String url = mlApiUrl + "/health";
            ResponseEntity<String> response = restTemplate.getForEntity(url, String.class);
            return response.getStatusCode().is2xxSuccessful();
        } catch (Exception e) {
            log.debug("ML model API not available: {}", e.getMessage());
            return false;
        }
    }

    // DTO classes for API communication
    @Data
    @AllArgsConstructor
    @NoArgsConstructor
    private static class MLAnalysisRequest {
        private String code;
        private String filename;
    }

    @Data
    @AllArgsConstructor
    @NoArgsConstructor
    private static class MLAnalysisResponse {
        @JsonProperty("is_vulnerable")
        private boolean isVulnerable;

        @JsonProperty("confidence")
        private double confidence;

        @JsonProperty("prediction")
        private String prediction;

        @JsonProperty("filename")
        private String filename;
    }
}